<!DOCTYPE html>
<html>
  <meta charset="UTF-8">
  <head>
    <link href="https://fonts.googleapis.com/css2?family=Acme&display=swap" rel="stylesheet">
    <title>Moja pierwsza gra w JavaScript v1.0</title>
  </head>
  <body style="margin: 0px; font-family: 'Acme', sans-serif;">
    <script>
// CONSTS
      var MAX_CANVAS_WIDTH = 1920;
      var MAX_CANVAS_HEIGHT = 1080;
      var CANVAS_WIDTH = setWindowWidth();
      var CANVAS_HEIGHT = setWindowHeight();
      var GROUND_FROM_DOWN_DISTANCE = 100;
      var GROUND_Y = setGroundY();
      var BACKGROUND_WIDTH = 1920;
      var BACKGROUND_Y_OFFSET = setBackgroundYOffset();
      var JUMP_KEYCODE = 32;
      var MIN_DISTANCE_BETWEEN_ENEMYS = 400;
      var MAX_DISTANCE_BETWEEN_ENEMYS = 1200;
      var MAX_ACTIVE_ENEMY = 3;
      var SCREENSHAKE_RADIUS = 16;
      var START_GAME_MODE = 0;
      var PLAY_GAME_MODE = 1;
      var GAME_OVER_GAME_MODE = 2;
      var GAME_OVER_TEXT = 'GAME OVER'

      var HERO_WIDTH = 181;
      var HERO_HEIGHT = 229;
      var HERO_Y_ACCELERATION = 1;
      var HERO_JUMP_SPEED = 18;
      var HERO_X_SPEED = 5;
      var HERO_NR_ANIMATION_FRAMES = 7;
      var HERO_ANIMATION_SPEED = 4;
      var HERO_MAX_HEALTH = 100;

      var ENEMY_WIDTH = 141;
      var ENEMY_HEIGHT = 139;
      var ENEMY_NR_ANIMATION_FRAMES = 9;
      var ENEMY_ANIMATION_SPEED = 5;
      var ENEMY_X_SPEED = 4;

      function setWindowWidth() {
        return (window.innerWidth < MAX_CANVAS_WIDTH) ? window.innerWidth : MAX_CANVAS_WIDTH;
      }
      function setWindowHeight() {
        return (window.innerHeight < MAX_CANVAS_HEIGHT) ? window.innerHeight : MAX_CANVAS_HEIGHT;
      }
      function setGroundY() {
        return (CANVAS_HEIGHT - GROUND_FROM_DOWN_DISTANCE);
      }
      function setBackgroundYOffset() {
        return - (150 + MAX_CANVAS_HEIGHT - window.innerHeight - GROUND_FROM_DOWN_DISTANCE);
      }

// CONFIG
      var canvas = document.createElement('canvas');
      var c = canvas.getContext('2d');
      canvas.width = CANVAS_WIDTH;
      canvas.height = CANVAS_HEIGHT;
      document.body.appendChild(canvas);

      var heroImage = new Image();
      var enemyImage = new Image();
      var backgroundImage = new Image();
      var bush1Image = new Image();
      var bush2Image = new Image();
      heroImage.src = 'images/animatedHero.png';
      enemyImage.src = 'images/animatedRobot.png';
      backgroundImage.src = 'images/background2.png';
      bush1Image.src = 'images/bush1.png';
      bush2Image.src = 'images/bush2.png';

      var heroSpriteSheet = {
        nrFramesPerRow: 5,
        spriteWidth: HERO_WIDTH,
        spriteHeight: HERO_HEIGHT,
        image: heroImage
      };

      var enemySpriteSheet = {
        nrFramesPerRow: 3,
        spriteWidth: ENEMY_WIDTH,
        spriteHeight: ENEMY_HEIGHT,
        image: enemyImage
      };

      var heroCollisionRectangle = {
        xOffset: 60,
        yOffset: 20,
        width: 50,
        height: 200
      };

      var enemyCollisionRectangle = {
        xOffset: 60,
        yOffset: 20,
        width: 50,
        height: 100
      };

      var enemyData = [];

      var heroHealth = HERO_MAX_HEALTH;
      var heroPositionX = CANVAS_WIDTH / 2;
      var heroPositionY = -180;
      var heroYSpeed = 0;
      var jumpKeyIsPressed = false;
      var heroIsInTheAir = true;
      var heroFrameNr = 0;
      var gameFrameCounter = 0;
      var screenshake = false;
      var gameMode = PLAY_GAME_MODE;

      var cameraX = 0;
      var cameraY = 0;

      var bushData = generateBushes();

      window.addEventListener('keydown', onKeyDown);
      window.addEventListener('keyup', onKeyUp);
      window.addEventListener('load', start);
      window.addEventListener("touchstart", onScreenTouchStart, false);
      window.addEventListener("touchend", onScreenTouchEnd, false);

      function start() {
        window.requestAnimationFrame(mainLoop);
      }

      function generateBushes() {
        var generatedBushData = [];
        var bushX = 0;
        while (bushX < (2 * CANVAS_WIDTH)) {
          var bushImage;
          if (Math.random() >= 0.5) {
            bushImage = bush1Image;
          } else {
            bushImage = bush2Image;
          }
          generatedBushData.push({
            x: bushX,
            y: 80 + Math.random() * 20,
            image: bushImage
          });
          bushX += 150 + Math.random() * 200;
        }
        return generatedBushData;
      }

// MAIN LOOP
      function mainLoop() {
        update();
        draw();
        window.requestAnimationFrame(mainLoop);
      }

// STEERING
      function onKeyDown(event) {
        if (event.keyCode === JUMP_KEYCODE) {
          jumpKeyIsPressed = true;
        }
      }
      function onKeyUp(event) {
        if (event.keyCode === JUMP_KEYCODE) {
          jumpKeyIsPressed = false;
        }
      }
      function onScreenTouchStart(event) {
        jumpKeyIsPressed = true;
      }
      function onScreenTouchEnd(event) {
        jumpKeyIsPressed = false;
      }

// UPDATE
      function update() {
        if (gameMode != PLAY_GAME_MODE) { return };
        gameFrameCounter = gameFrameCounter + 1;
        heroPositionX = heroPositionX + HERO_X_SPEED;
        if (jumpKeyIsPressed && !heroIsInTheAir) {
          heroYSpeed = -HERO_JUMP_SPEED;
          heroIsInTheAir = true;
        };
        heroPositionY = heroPositionY + heroYSpeed;
        heroYSpeed = heroYSpeed + HERO_Y_ACCELERATION;
        if (heroPositionY > (GROUND_Y - HERO_HEIGHT) ) {
          heroPositionY = GROUND_Y - HERO_HEIGHT;
          heroYspeed = 0;
          heroIsInTheAir = false;
        }
  // update animation
        if (heroFrameNr >= HERO_NR_ANIMATION_FRAMES) {
          heroFrameNr = 0;
        }
        if ((gameFrameCounter % HERO_ANIMATION_SPEED) === 0) {
          heroFrameNr = heroFrameNr + 1;
          if (heroFrameNr >= HERO_NR_ANIMATION_FRAMES) {
            heroFrameNr = 0;
          }
        }
  // update camera
        cameraX = heroPositionX - 100;

  // update bush
        for (var i=0; i < bushData.length; i++) {
          if ((bushData[i].x - cameraX) < -CANVAS_WIDTH) {
            bushData[i].x += (2 * CANVAS_WIDTH) + 150;
          }
        }

  // update enemy
        screenshake = false;
        var heroTouchedAEnemy = updateEnemy();
        if (heroTouchedAEnemy) {
          screenshake = true;
          if (heroHealth > 0) { heroHealth -= 1; }
        }

   // check if game over
        if (heroHealth <= 0) {
          gameMode = GAME_OVER_GAME_MODE;
          screenshake = false;
        }
      }

      function updateEnemy() {
        var heroTouchedAEnemy = false;
        for (var i = 0; i < enemyData.length; i++) {
          if (doesHeroOverlapEnemy(
                heroPositionX + heroCollisionRectangle.xOffset,
                heroPositionY + heroCollisionRectangle.yOffset,
                heroCollisionRectangle.width,
                heroCollisionRectangle.height,
                enemyData[i].x + enemyCollisionRectangle.xOffset,
                enemyData[i].y + enemyCollisionRectangle.yOffset,
                enemyCollisionRectangle.width,
                enemyCollisionRectangle.height
              )) {
            heroTouchedAEnemy = true;
          }
          enemyData[i].x -= ENEMY_X_SPEED;
          if ((gameFrameCounter % ENEMY_ANIMATION_SPEED) === 0) {
            enemyData[i].frameNr = enemyData[i].frameNr + 1;
            if (enemyData[i].frameNr >= ENEMY_NR_ANIMATION_FRAMES) {
              enemyData[i].frameNr = 0;
            }
          }
        }

        var enemyIndex = 0;
        while (enemyIndex < enemyData.length) {
          if (enemyData[enemyIndex].x < cameraX - ENEMY_WIDTH) {
            enemyData.splice(enemyIndex, 1);
          } else {
            enemyIndex += 1;
          }
        }

        if (enemyData.length < MAX_ACTIVE_ENEMY) {
          var lastEnemyX = CANVAS_WIDTH;
          if (enemyData.length > 0) {
            lastEnemyX = enemyData[enemyData.length - 1].x;
          }
          var newEnemyX = lastEnemyX + MIN_DISTANCE_BETWEEN_ENEMYS + Math.random() * (MAX_DISTANCE_BETWEEN_ENEMYS - MIN_DISTANCE_BETWEEN_ENEMYS);
          enemyData.push({ x: newEnemyX, y: GROUND_Y - ENEMY_HEIGHT, frameNr: 0 });
        }
        return heroTouchedAEnemy;
      }

      function doesHeroOverlapEnemyAlongOneAxis(heroNearX, heroFarX, enemyNearX, enemyFarX) {
        var heroOverlapsNearEnemyEdge = (heroFarX >= enemyNearX) && (heroFarX <= enemyFarX);
        var heroOverlapsFarEnemyEdge = (heroNearX >= enemyNearX) && (heroNearX <= enemyFarX);
        var heroOverlapsEntireEnemyEdge = (heroNearX <= enemyNearX) && (heroFarX >= enemyFarX);
        return heroOverlapsNearEnemyEdge || heroOverlapsFarEnemyEdge || heroOverlapsEntireEnemyEdge;
      }

      function doesHeroOverlapEnemy(heroX, heroY, heroWidth, heroHeight, enemyX, enemyY, enemyWidth, enemyHeight) {
        var heroOverlapsEnemyOnXAxis = doesHeroOverlapEnemyAlongOneAxis(heroX, heroX + heroWidth, enemyX, enemyX + enemyWidth);
        var heroOverlapsEnemyOnYAxis = doesHeroOverlapEnemyAlongOneAxis(heroY, heroY + heroHeight, enemyY, enemyY + enemyHeight);
        return heroOverlapsEnemyOnXAxis && heroOverlapsEnemyOnYAxis;
      }

// DRAW
      function draw() {
        // Screen shake
        var shakenCameraX = cameraX;
        var shakenCameraY = cameraY;
        if (screenshake) {
          shakenCameraX += (Math.random() - 0.5) * SCREENSHAKE_RADIUS;
          shakenCameraY += (Math.random() - 0.5) * SCREENSHAKE_RADIUS;
        }

        // Sky
        c.fillStyle = 'LightSteelBlue';
        c.fillRect(0, 0, CANVAS_WIDTH, GROUND_Y - 40);

        // Background
        var backgroundX = - (shakenCameraX % BACKGROUND_WIDTH);
        c.drawImage(backgroundImage, backgroundX, BACKGROUND_Y_OFFSET);
        c.drawImage(backgroundImage, backgroundX + BACKGROUND_WIDTH, BACKGROUND_Y_OFFSET);

        // Ground
        c.fillStyle = 'MediumSeaGreen';
        c.fillRect(0, GROUND_Y - 40, CANVAS_WIDTH, CANVAS_HEIGHT - GROUND_Y + 40);

        // Bush
        for (var i = 0; i < bushData.length; i++) {
          c.drawImage(bushData[i].image, bushData[i].x - shakenCameraX, GROUND_Y - bushData[i].y - shakenCameraY);
        }

        // Enemy
        for (var i = 0; i < enemyData.length; i++) {
          drawAnimatedSprite(enemyData[i].x - shakenCameraX, enemyData[i].y - shakenCameraY, enemyData[i].frameNr, enemySpriteSheet);
        }

        // Hero
        drawAnimatedSprite(heroPositionX - shakenCameraX, heroPositionY - shakenCameraY, heroFrameNr, heroSpriteSheet);

        // Distance
        var heroDistance = heroPositionX / 100;
        c.fillStyle = 'black';
        c.font = '48px Acme';
        c.fillText(heroDistance.toFixed(0) + 'm', 20, 40);

        // Health
        c.fillStyle = 'blue';
        c.fillRect((window.innerWidth - 400), 10, heroHealth / HERO_MAX_HEALTH * 380, 20);
        c.strokeStyle = 'green';
        c.strokeRect((window.innerWidth - 400), 10, 380, 20);

        if (gameMode === GAME_OVER_GAME_MODE) {
          c.fillStyle = 'Red';
          c.font = '96px Acme';

          let textPositionX = (window.innerWidth - c.measureText(GAME_OVER_TEXT).width) / 2;
          let textPositionY = (window.innerHeight - 90) / 2;

          c.fillText(GAME_OVER_TEXT, textPositionX.toFixed(0), textPositionY.toFixed(0));
        }
      }

      function drawAnimatedSprite(screenX, screenY, frameNr, spriteSheet) {
        var spriteSheetRow = Math.floor(frameNr / spriteSheet.nrFramesPerRow);
        var spriteSheetColumn = frameNr % spriteSheet.nrFramesPerRow;
        var spriteSheetX = spriteSheetColumn * spriteSheet.spriteWidth;
        var spriteSheetY = spriteSheetRow * spriteSheet.spriteHeight;
        c.drawImage(
          spriteSheet.image,
          spriteSheetX,
          spriteSheetY,
          spriteSheet.spriteWidth,
          spriteSheet.spriteHeight,
          screenX,
          screenY,
          spriteSheet.spriteWidth,
          spriteSheet.spriteHeight
        );
      }
    </script>
  </body>
</html>
